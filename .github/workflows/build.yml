name: CI/CD

on:
  push:
    branches:
      - '**'
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.github/workflows/build.yml'
      - "install_secp256k1.sh"
  pull_request:
    branches:
      - '**'
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'poetry.lock'
      - '.github/workflows/build.yml'
      - "install_secp256k1.sh"

jobs:

  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
      fail-fast: true
    
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install secp256k1
      run: |
        bash install_secp256k1.sh
        echo "/usr/local/lib" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Install secp256k1-py
      run: pip install python-secp256k1-cardano

    - name: Verify secp256k1 installation
      run: |
        python -c "import pysecp256k1; print('secp256k1 installed successfully')"

    - name: Install dependencies
      run: |
        pip install -U poetry
        poetry install --with dev
    
    - name: Run tests and coverage
      run: |
        poetry run black --check .
        poetry run coverage run --source=uplc -m pytest tests
        poetry run coverage run -a --source=uplc -m uplc parse examples/fibonacci.uplc
        poetry run coverage run -a --source=uplc -m uplc dump examples/fibonacci.uplc --dialect legacy-aiken
        poetry run coverage run -a --source=uplc -m uplc dump examples/fibonacci.uplc --dialect plutus --unique-varnames
        poetry run coverage run -a --source=uplc -m uplc eval examples/fibonacci.uplc "(con integer 5)"
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -fconstant-folding
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -fremove-force-delay
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -fdeduplicate
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -ffold_apply_lambda_increase 1.2
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -O0
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -O1
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -O2
        poetry run coverage run -a --source=uplc -m uplc build examples/fibonacci.uplc -O3
        poetry run coverage run -a --source=uplc -m uplc dump build/fibonacci/script.cbor --from-cbor

    - name: Upload coverage data to coveralls.io
      run: |
        pip install coveralls
        coveralls || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COVERALLS_FLAG_NAME: ${{ matrix.python-version }}
        COVERALLS_PARALLEL: true

  coveralls:
    name: Indicate completion to coveralls.io
    needs: [build]
    if: always()
    runs-on: ubuntu-latest
    container: python:3-slim
    steps:
      - name: Install coveralls
        run: pip3 install --upgrade coveralls
      - name: Finished
        run: coveralls --finish || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
